// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User authentication and profile
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  phone     String?
  company   String?
  role      String?
  bio       String?
  avatar    String?
  address   String?  // Added for profile completeness
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions     Session[]
  settings     UserSettings?
  activities   Activity[]
  properties   Property[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// User settings and preferences
model UserSettings {
  id                   String  @id @default(cuid())
  userId               String  @unique
  appName              String  @default("Cornerstone Realty")
  rentDueReminderDays  Int     @default(7)
  hasSeenWelcomeGuide  Boolean @default(false)
  reminderText         String? 
  reminderEnabled      Boolean @default(false)
  currencySymbol       String  @default("â‚¦") // Currency symbol preference
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// App-wide settings
model AppSettings {
  id           String   @id @default(cuid())
  key          String   @unique
  value        String
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("app_settings")
}

// Property types management
model PropertyType {
  id        String   @id @default(cuid())
  name      String   @unique
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("property_types")
}

// Twilio settings
model TwilioSettings {
  id              String   @id @default(cuid())
  accountSid      String?
  authToken       String?
  phoneNumber     String?
  isEnabled       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("twilio_settings")
}

// Activity tracking
model Activity {
  id          String   @id @default(cuid())
  userId      String?
  type        String
  title       String
  description String?
  metadata    String?  // JSON string for additional data
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("activities")
}

// Enhanced Property model to replace localStorage
model Property {
  id                   String   @id @default(cuid())
  name                 String
  address              String
  type                 String
  status               String
  yearlyRent           Int
  bedrooms             Int?
  bathrooms            Int?
  area                 Int?
  description          String
  amenities            String
  images               String   // JSON string for multiple images
  yearBuilt            Int
  parkingSpaces        String
  numberOfRooms        Int?
  numberOfKitchens     Int?
  numberOfBathrooms    Int?
  waterAvailability    String?
  userId               String?  // Owner/creator of the property
  isCustom             Boolean  @default(false) // Distinguish custom vs default properties
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  rooms               Room[]
  payments            Payment[]
  maintenanceRequests MaintenanceRequest[]
  user                User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Indexes for performance
  @@index([type])
  @@index([status])
  @@index([userId])
  @@index([isCustom])
  @@index([createdAt])
  @@index([name])
  @@index([type, status])
  @@index([userId, isCustom])
  @@map("properties")
}

model Room {
  id              String   @id @default(cuid())
  propertyId      String
  propertyName    String
  roomPrefix      String   // Room prefix (e.g., "A", "B", "RM")
  roomNumber      String   // Room number (e.g., "101", "03")
  roomIdentifier  String   // Full room identifier (e.g., "A-101", "RM-03")
  status          String   // 'available', 'occupied', 'maintenance', 'reserved'
  yearlyRent      Int
  maxOccupants    Int      @default(1)  // Maximum number of occupants allowed
  currentOccupants Int     @default(0)  // Current number of occupants
  roomType        String?  // 'single', 'shared', 'studio', 'apartment'
  amenities       String?  // JSON string for room-specific amenities
  floor           Int?     // Floor number
  size            Float?   // Room size in square meters
  hasPrivateBath  Boolean  @default(false)
  hasKitchen      Boolean  @default(false)
  rentStartDate   String?
  rentExpiryDate  String?
  lastOccupiedDate String? // Track when room was last occupied
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  property  Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  occupants RoomOccupant[]

  // Unique constraint to prevent duplicate room identifiers per property
  @@unique([propertyId, roomIdentifier])
  
  @@map("rooms")
}

model RoomOccupant {
  id                 String   @id @default(cuid())
  roomId             String
  name               String
  phone              String
  email              String?  // Optional email for better communication
  nextOfKin          String
  nextOfKinPhone     String
  numberOfOccupants  Int
  kitchenAccess      String?
  rentStartDate      String
  rentExpiryDate     String
  totalRent          Int
  amountPaid         Int
  paymentStatus      String   // 'pending', 'partial', 'completed', 'overdue'
  assignmentStatus   String   @default("active") // 'active', 'moved_out', 'terminated'
  moveInDate         String?  // Actual move-in date (can differ from rent start)
  moveOutDate        String?  // Actual move-out date
  securityDeposit    Int      @default(0)
  depositStatus      String   @default("pending") // 'pending', 'paid', 'refunded'
  emergencyContact   String?  // Additional emergency contact
  occupation         String?  // Occupant's job/profession
  idNumber           String?  // National ID or passport number
  issues             String   // JSON string for issues
  notes              String   // JSON string for notes
  assignedBy         String?  // User ID who assigned this occupant
  assignedAt         DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Indexes for performance and queries
  @@index([roomId])
  @@index([assignmentStatus])
  @@index([paymentStatus])
  @@index([rentExpiryDate])
  @@index([roomId, assignmentStatus])
  @@map("room_occupants")
}

model Payment {
  id           String   @id @default(cuid())
  propertyId   String
  propertyName String
  tenantName   String
  amount       Int
  type         String
  method       String
  status       String
  dueDate      String
  paidDate     String?
  description  String
  roomNumber   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model MaintenanceRequest {
  id             String   @id @default(cuid())
  propertyId     String
  propertyName   String
  title          String
  description    String
  category       String
  priority       String
  status         String
  reportedBy     String
  reportedDate   String
  assignedTo     String?
  estimatedCost  Int
  actualCost     Int?
  completedDate  String?
  resolutionTime Int?
  notes          String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("maintenance_requests")
}

// New model to track room assignment history
model RoomAssignmentHistory {
  id            String   @id @default(cuid())
  roomId        String
  occupantId    String?  // Can be null if tracking room status changes
  propertyId    String
  action        String   // 'assigned', 'moved_out', 'transferred', 'status_changed'
  fromStatus    String?  // Previous room status
  toStatus      String?  // New room status
  assignedBy    String?  // User who made the assignment
  reason        String?  // Reason for the change
  notes         String?
  effectiveDate String   // When the change took effect
  createdAt     DateTime @default(now())

  // Relations (no foreign keys to allow historical data even if records are deleted)
  @@index([roomId])
  @@index([occupantId])
  @@index([propertyId])
  @@index([action])
  @@index([effectiveDate])
  @@map("room_assignment_history")
}
